"use strict";(()=>{var e={};e.id=498,e.ids=[498],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},35900:e=>{e.exports=require("pg")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},73837:e=>{e.exports=require("util")},16093:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>m,originalPathname:()=>g,patchFetch:()=>y,requestAsyncStorage:()=>d,routeModule:()=>c,serverHooks:()=>h,staticGenerationAsyncStorage:()=>l,staticGenerationBailout:()=>E});var a={};r.r(a),r.d(a,{POST:()=>u});var s=r(95419),o=r(69108),n=r(99678),i=r(23106);let p=new(r(56846)).Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16",typescript:!0}),u=async e=>{let t;let r=e.headers.get("stripe-signature");try{if(t=p.webhooks.constructEvent(await e.text(),r,process.env.STRIPE_WEBHOOK_SECRET),"payment_intent.succeeded"===t.type){let e=t.data.object,r=`
                    SELECT balance FROM balances WHERE user_id = $1
                `,a=`
                    UPDATE balances SET balance = balance + $1 WHERE user_id = $2
                `,s=`    
                    INSERT INTO transactions (user_id, amount, type, prev_balance, new_balance) VALUES
                    ($1, $2, $3, $4, $5)
                `,o=await i.d.query(r,[e.metadata.user_id]),n=await i.d.connect();try{await n.query("BEGIN"),await n.query(a,[e.amount,e.metadata.user_id]),await n.query(s,[e.metadata.user_id,e.amount,"stripe",o.rows[0].balance,parseInt(o.rows[0].balance)+e.amount]),await n.query("COMMIT")}catch(e){return console.log(e.message),Response.json(e.message,{status:500})}}return console.log("Unhandled event type",t.type),Response.json({recieved:!0})}catch(e){return console.log(e.message),Response.json(e.message,{status:500})}},c=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/stripehook/route",pathname:"/api/stripehook",filename:"route",bundlePath:"app/api/stripehook/route"},resolvedPagePath:"/home/Frasier/Documents/web/JLSM/jlsm/app/api/stripehook/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:d,staticGenerationAsyncStorage:l,serverHooks:h,headerHooks:m,staticGenerationBailout:E}=c,g="/api/stripehook/route";function y(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:l})}},23106:(e,t,r)=>{r.d(t,{d:()=>a});let a=new(r(35900)).Pool({connectionString:process.env.DBCONNSTR})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[638,462],()=>r(16093));module.exports=a})();